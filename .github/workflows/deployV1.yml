name: DÃ©ploiement en Production

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    name: DÃ©ploiement VPS
    runs-on: ubuntu-latest

    steps:
      #--------------------------------------------------------------------------------------------------------
      # ðŸ“¥ RÃ©cupÃ©ration du code (utile surtout pour logs / cohÃ©rence du workflow)
      #--------------------------------------------------------------------------------------------------------
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      #--------------------------------------------------------------------------------------------------------
      # ðŸ” Chargement de la clÃ© SSH privÃ©e (connexion GitHub Actions â†’ VPS)
      #--------------------------------------------------------------------------------------------------------
      - name: ðŸ” Connexion SSH via clÃ© privÃ©e
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      #--------------------------------------------------------------------------------------------------------
      # ðŸ”’ SÃ©curisation SSH : ajout de la clÃ© du VPS dans known_hosts
      # Ã‰vite StrictHostKeyChecking=no (bonne pratique sÃ©curitÃ©)
      #--------------------------------------------------------------------------------------------------------
      - name: ðŸ”’ Enregistrement du VPS dans known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      #--------------------------------------------------------------------------------------------------------
      # ðŸš€ DÃ©ploiement sur le VPS
      #--------------------------------------------------------------------------------------------------------
      - name: ðŸš€ DÃ©ployer sur le VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh "$VPS_USER@$VPS_HOST" "export PROJECT_PATH='$PROJECT_PATH'; bash -s" << 'EOF'
            set -e  # Stoppe immÃ©diatement Ã  la moindre erreur

            echo "ðŸš€ DÃ©but du dÃ©ploiement sur le VPS"

            #--------------------------------------------------------------------------------------------------------

            echo "ðŸ“ AccÃ¨s au dossier du projet"
            cd "$PROJECT_PATH"
            echo "âœ… AccÃ¨s au dossier du projet : OK"

            #--------------------------------------------------------------------------------------------------------

            echo "â³ Etape 1/6 : Synchronisation du dÃ©pÃ´t Git"

            # TÃ©lÃ©charge toutes les mises Ã  jour du dÃ©pÃ´t distant
            git fetch --all

            # Se positionne sur la branche deploy
            # Si elle n'existe pas localement, elle est recrÃ©Ã©e depuis origin/deploy
            git checkout deploy || git checkout -b deploy origin/deploy

            # Force l'Ã©tat local Ã  Ãªtre strictement identique au distant
            git reset --hard origin/deploy

            echo "âœ… Etape 1/6 : Synchronisation Git - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "â³ Etape 2/6 : Build + redÃ©marrage des containers Docker"

            # Reconstruit les images Docker
            # RedÃ©marre les services
            # Supprime les conteneurs orphelins
            sudo docker compose up -d --build --remove-orphans

            echo "âœ… Etape 2/6 : Build + redÃ©marrage Docker - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "â³ Etape 3/6 : Nettoyage des conteneurs arrÃªtÃ©s"
            sudo docker container prune -f || true
            echo "âœ… Etape 3/6 : Nettoyage conteneurs - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "â³ Etape 4/6 : Suppression des images Docker non utilisÃ©es"
            sudo docker image prune -af || true
            echo "âœ… Etape 4/6 : Nettoyage images - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "â³ Etape 5/6 : Nettoyage du cache BuildKit"
            sudo docker builder prune -af || true
            echo "âœ… Etape 5/6 : Nettoyage BuildKit - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "â³ Etape 6/6 : Nettoyage des rÃ©seaux Docker inutilisÃ©s"
            sudo docker network prune -f || true
            echo "âœ… Etape 6/6 : Nettoyage rÃ©seaux - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s"
          EOF
