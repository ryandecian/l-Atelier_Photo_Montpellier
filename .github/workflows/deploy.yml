name: D√©ploiement en Production

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    name: D√©ploiement VPS
    runs-on: ubuntu-latest

    steps:
      #--------------------------------------------------------------------------------------------------------
      # üì• R√©cup√©ration du code (utile surtout pour logs / coh√©rence du workflow)
      #--------------------------------------------------------------------------------------------------------
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      #--------------------------------------------------------------------------------------------------------
      # üîê Chargement de la cl√© SSH priv√©e (connexion GitHub Actions ‚Üí VPS)
      #--------------------------------------------------------------------------------------------------------
      - name: üîê Connexion SSH via cl√© priv√©e
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      #--------------------------------------------------------------------------------------------------------
      # üîí S√©curisation SSH : ajout de la cl√© du VPS dans known_hosts
      # √âvite StrictHostKeyChecking=no (bonne pratique s√©curit√©)
      #--------------------------------------------------------------------------------------------------------
      - name: üîí Enregistrement du VPS dans known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      #--------------------------------------------------------------------------------------------------------
      # üöÄ D√©ploiement sur le VPS
      #--------------------------------------------------------------------------------------------------------
      - name: üöÄ D√©ployer sur le VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh "$VPS_USER@$VPS_HOST" "export PROJECT_PATH='$PROJECT_PATH'; bash -s" << 'EOF'
            set -e  # Stoppe imm√©diatement √† la moindre erreur

            echo "üöÄ D√©but du d√©ploiement sur le VPS"

            #--------------------------------------------------------------------------------------------------------

            echo "üìÅ Acc√®s au dossier du projet"
            cd "$PROJECT_PATH"
            echo "‚úÖ Acc√®s au dossier du projet : OK"

            #--------------------------------------------------------------------------------------------------------

            echo "‚è≥ Etape 1/6 : Synchronisation du d√©p√¥t Git"

            # T√©l√©charge toutes les mises √† jour du d√©p√¥t distant
            git fetch --all

            # Se positionne sur la branche deploy
            # Si elle n'existe pas localement, elle est recr√©√©e depuis origin/deploy
            git checkout deploy || git checkout -b deploy origin/deploy

            # Force l'√©tat local √† √™tre strictement identique au distant
            git reset --hard origin/deploy

            echo "‚úÖ Etape 1/6 : Synchronisation Git - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "‚è≥ Etape 2/6 : Build + red√©marrage des containers Docker"

            # Reconstruit les images Docker
            # Red√©marre les services
            # Supprime les conteneurs orphelins
            sudo docker compose up -d --build --remove-orphans

            echo "‚úÖ Etape 2/6 : Build + red√©marrage Docker - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "‚è≥ Etape 3/6 : Nettoyage des conteneurs arr√™t√©s"
            sudo docker container prune -f || true
            echo "‚úÖ Etape 3/6 : Nettoyage conteneurs - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "‚è≥ Etape 4/6 : Suppression des images Docker non utilis√©es"

            echo "Affichage des dangling images (sans tag) avant nettoyage :"
            sudo docker images --filter "dangling=true" || true

            echo "Supprime les dangling images (sans tag) de plus de 24h."
            sudo docker image prune -f --filter "dangling=true" --filter "until=24h" || true

            echo "Affichage des dangling images (sans tag) apr√®s nettoyage :"
            sudo docker images --filter "dangling=true" || true

            echo "‚úÖ Etape 4/6 : Nettoyage images - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "‚è≥ Etape 5/6 : Nettoyage du cache BuildKit"

            # Nettoyage du cache BuildKit (> 24h)"
            sudo docker builder prune -f --filter "until=24h" || true

            echo "‚úÖ Etape 5/6 : Nettoyage BuildKit - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "‚è≥ Etape 6/6 : Nettoyage des r√©seaux Docker inutilis√©s"
            sudo docker network prune -f || true
            echo "‚úÖ Etape 6/6 : Nettoyage r√©seaux - OK"

            #--------------------------------------------------------------------------------------------------------

            echo "‚úÖ D√©ploiement termin√© avec succ√®s"
          EOF
