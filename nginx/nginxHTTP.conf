# âœ¨ Active les Ã©vÃ©nements de gestion de connexions
events {}

# ğŸŒ Configuration principale du serveur HTTP
http {
    # ğŸ“¦ Charge les types MIME standards (pour que Nginx comprenne .js, .css, etc.)
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # âš™ï¸ Active l'envoi efficace de fichiers
    sendfile        on;

    # ğŸ” Garde les connexions HTTP ouvertes 65s pour les optimiser
    keepalive_timeout  65;

    # ğŸŒ DÃ©clare les serveurs internes vers lesquels Nginx reverse proxy
    # (frontend non utilisÃ© car on sert les builds via "root")
    upstream backend {
        server server:8080;
    }

    # ---------------------------------------------
    # ğŸŒ 1. Compression GZIP pour tous les fichiers textes
    # ---------------------------------------------
    gzip on;  # âœ… Active la compression
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        application/xml+rss
        image/svg+xml;  # âš ï¸ Vite produit souvent des SVG
    gzip_min_length 256;  # Ne compresse que si > 256 octets
    gzip_vary on;         # Ajoute l'en-tÃªte Vary pour le cache/CDN
    gzip_proxied any;     # Autorise compression mÃªme derriÃ¨re un proxy
    gzip_comp_level 6;    # Bon compromis entre perf & compression

    # ---------------------------------------------
    # ğŸ” 2. Gestion propre des WebSockets (si utilisÃ©s)
    # ---------------------------------------------
    # âœ… Ã‰vite de forcer "Connection: upgrade" sur toutes les requÃªtes
    # - si Upgrade est prÃ©sent => upgrade
    # - sinon => close
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # ---------------------------------------------
    # ğŸ” 3. LET'S ENCRYPT â€” ACME CHALLENGE (HTTP)
    # ---------------------------------------------
    # âœ… Le challenge Let's Encrypt a besoin d'un serveur HTTP (port 80)
    # âœ… MÃªme en mode HTTP-only, on le garde pour prÃ©parer la bascule HTTPS
    location ^~ /.well-known/acme-challenge/ {
        root /usr/share/nginx/html;
        default_type "text/plain";
    }

    # ============================================================
    # ğŸŒ 4. HTTP : MODE HTTP-ONLY TEMPORAIRE
    # Objectif : DÃ©marrer Nginx SANS certificats.
    # On garde le challenge Let's Encrypt, mais on NE redirige PAS vers HTTPS.
    # ============================================================
    # âœ”ï¸ HTTP - FRONTEND L'ATELIER PHOTO MONTPELLIER
    server {
        listen 80;
        server_name atelier-photo-montpellier.fr www.atelier-photo-montpellier.fr;

        # ğŸ—‚ï¸ Sert les fichiers du build React
        # âœ… Root factorisÃ© : on Ã©vite de rÃ©pÃ©ter "root" dans chaque location
        root /usr/share/nginx/html/lapm;
        index index.html;

        # ğŸ§  Active le cache (assets Vite hashÃ©s)
        # Vite gÃ©nÃ¨re gÃ©nÃ©ralement /assets/... avec un hash => on peut cache trÃ¨s longtemps
        location ^~ /assets/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        # ğŸ§  DÃ©sactive le cache sur index.html (SPA shell)
        # Important : Ã©vite de servir un vieux index qui pointe vers de nouveaux fichiers JS/CSS
        location = /index.html {
            add_header Cache-Control "no-store, no-cache, must-revalidate";
            expires off;
        }

        # âœ… Sert index.html mÃªme si un chemin est inconnu (React SPA)
        location / {
            try_files $uri $uri/ /index.html;
        }

        # ğŸ“¡ Proxy vers l'API backend (mÃªme en HTTP)
        location /api/ {
            proxy_pass http://backend/;  # âœ… Pas de prÃ©fixe cÃ´tÃ© backend => /api/users devient /users

            # ğŸ” RecommandÃ© (Express + Ã©ventuels WebSockets)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # âœ”ï¸ HTTP - FRONTEND KALEIDOPIX
    server {
        listen 80;
        server_name kaleidopix.fr www.kaleidopix.fr;

        # ğŸ—‚ï¸ Sert les fichiers du build React
        # âœ… Root factorisÃ© : on Ã©vite de rÃ©pÃ©ter "root" dans chaque location
        root /usr/share/nginx/html/kaleidopix;
        index index.html;

        # ğŸ§  Active le cache (assets Vite hashÃ©s)
        # Vite gÃ©nÃ¨re gÃ©nÃ©ralement /assets/... avec un hash => on peut cache trÃ¨s longtemps
        location ^~ /assets/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        # ğŸ§  DÃ©sactive le cache sur index.html (SPA shell)
        # Important : Ã©vite de servir un vieux index qui pointe vers de nouveaux fichiers JS/CSS
        location = /index.html {
            add_header Cache-Control "no-store, no-cache, must-revalidate";
            expires off;
        }

        # âœ… Sert index.html mÃªme si un chemin est inconnu (React SPA)
        location / {
            try_files $uri $uri/ /index.html;
        }

        # ğŸ“¡ Proxy vers l'API backend (mÃªme en HTTP)
        location /api/ {
            proxy_pass http://backend/;  # âœ… Pas de prÃ©fixe cÃ´tÃ© backend => /api/users devient /users

            # ğŸ” RecommandÃ© (Express + Ã©ventuels WebSockets)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # âœ”ï¸ HTTP - BACKEND API
    server {
        listen 80;
        server_name api.atelier-photo-montpellier.fr;

        # ğŸ“¡ Route vers le serveur backend
        location / {
            proxy_pass http://backend/;

            # ğŸ” RecommandÃ© (Express + Ã©ventuels WebSockets)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
