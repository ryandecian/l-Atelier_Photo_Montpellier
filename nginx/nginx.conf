# âœ¨ Active les Ã©vÃ©nements de gestion de connexions
events {}

# ğŸŒ Configuration principale du serveur HTTP
http {
    # ğŸ“¦ Charge les types MIME standards (pour que Nginx comprenne .js, .css, etc.)
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # âš™ï¸ Active l'envoi efficace de fichiers
    sendfile        on;

    # ğŸ” Garde les connexions HTTP ouvertes 65s pour les optimiser
    keepalive_timeout  65;

    # ğŸŒ DÃ©clare les serveurs internes vers lesquels Nginx reverse proxy
    # (frontend non utilisÃ© car on sert les builds via "root")
    upstream backend {
        server server:8080;
    }

    # ---------------------------------------------
    # ğŸŒ 1. Compression GZIP pour tous les fichiers textes
    # ---------------------------------------------
    gzip on;  # âœ… Active la compression
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        application/xml+rss
        image/svg+xml;  # âš ï¸ Vite produit souvent des SVG
    gzip_min_length 256;  # Ne compresse que si > 256 octets
    gzip_vary on;         # Ajoute l'en-tÃªte Vary pour le cache/CDN
    gzip_proxied any;     # Autorise compression mÃªme derriÃ¨re un proxy
    gzip_comp_level 6;    # Bon compromis entre perf & compression

    # ---------------------------------------------
    # ğŸ” 2. Gestion propre des WebSockets (si utilisÃ©s)
    # ---------------------------------------------
    # âœ… Ã‰vite de forcer "Connection: upgrade" sur toutes les requÃªtes
    # - si Upgrade est prÃ©sent => upgrade
    # - sinon => close
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # ---------------------------------------------
    # ğŸ” 3. LET'S ENCRYPT â€” ACME CHALLENGE (HTTP + HTTPS)
    # ---------------------------------------------

    # ---------------------------------------------
    # ğŸŒ 4. Redirection HTTP â†’ HTTPS
    # ---------------------------------------------
    # âœ”ï¸ Redirection HTTP â†’ HTTPS pour L'ATELIER PHOTO MONTPELLIER
    server {
        listen 80;
        server_name atelier-photo-montpellier.fr www.atelier-photo-montpellier.fr;

        # ğŸ” LET'S ENCRYPT â€” ACME CHALLENGE (HTTP)
        location ^~ /.well-known/acme-challenge/ {
            root /usr/share/nginx/html;
            default_type "text/plain";
        }

        # ğŸ” Redirige tout en HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # âœ”ï¸ Redirection HTTP â†’ HTTPS pour KALEIDOPIX
    server {
        listen 80;
        server_name kaleidopix.fr www.kaleidopix.fr;

        # ğŸ” LET'S ENCRYPT â€” ACME CHALLENGE (HTTP)
        location ^~ /.well-known/acme-challenge/ {
            root /usr/share/nginx/html;
            default_type "text/plain";
        }

        # ğŸ” Redirige tout en HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # âœ”ï¸ Redirection HTTP â†’ HTTPS pour l'API
    server {
        listen 80;
        server_name api.atelier-photo-montpellier.fr;

        # ğŸ” LET'S ENCRYPT â€” ACME CHALLENGE (HTTP)
        location ^~ /.well-known/acme-challenge/ {
            root /usr/share/nginx/html;
            default_type "text/plain";
        }

        # ğŸ” Redirige tout en HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # ---------------------------------------------
    # ğŸŒ 5. HTTPS - FRONTEND (React build)
    # ---------------------------------------------
    # âœ”ï¸ HTTPS - FRONTEND L'ATELIER PHOTO MONTPELLIER
    server {
        listen 443 ssl;  # âœ… Active SSL
        http2 on;        # ğŸ” Active HTTP/2
        server_name atelier-photo-montpellier.fr www.atelier-photo-montpellier.fr;

        ssl_certificate /etc/letsencrypt/live/atelier-photo-montpellier.fr/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/atelier-photo-montpellier.fr/privkey.pem;

        # ğŸ”’ Durcissement TLS/HSTS
        ssl_protocols TLSv1.2 TLSv1.3;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # ğŸ—‚ï¸ Sert les fichiers du build React
        # âœ… Root factorisÃ© : on Ã©vite de rÃ©pÃ©ter "root" dans chaque location
        root /usr/share/nginx/html/lapm;
        index index.html;

        # ğŸ” LET'S ENCRYPT â€” ACME CHALLENGE (HTTP)
        location ^~ /.well-known/acme-challenge/ {
            root /usr/share/nginx/html;
            default_type "text/plain";
        }

        # ğŸ§  Active le cache (assets Vite hashÃ©s)
        # Vite gÃ©nÃ¨re gÃ©nÃ©ralement /assets/... avec un hash => on peut cache trÃ¨s longtemps
        location ^~ /assets/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        # ğŸ§  DÃ©sactive le cache sur index.html (SPA shell)
        # Important : Ã©vite de servir un vieux index qui pointe vers de nouveaux fichiers JS/CSS
        location = /index.html {
            add_header Cache-Control "no-store, no-cache, must-revalidate";
            expires off;
        }

        # âœ… Sert index.html mÃªme si un chemin est inconnu (React SPA)
        location / {
            try_files $uri $uri/ /index.html;
        }

        # ğŸ“¡ Proxy vers l'API backend
        location /api/ {
            proxy_pass http://backend/;  # âœ… Pas de prÃ©fixe cÃ´tÃ© backend => /api/users devient /users

            # ğŸ” RecommandÃ© (Express + Ã©ventuels WebSockets)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # âœ”ï¸ HTTPS - FRONTEND KALEIDOPIX
    server {
        listen 443 ssl;  # âœ… Active SSL
        http2 on;        # ğŸ” Active HTTP/2
        server_name kaleidopix.fr www.kaleidopix.fr;

        ssl_certificate /etc/letsencrypt/live/kaleidopix.fr/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/kaleidopix.fr/privkey.pem;

        # ğŸ”’ Durcissement TLS/HSTS
        ssl_protocols TLSv1.2 TLSv1.3;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # ğŸ—‚ï¸ Sert les fichiers du build React
        # âœ… Root factorisÃ© : on Ã©vite de rÃ©pÃ©ter "root" dans chaque location
        root /usr/share/nginx/html/kaleidopix;
        index index.html;

        # ğŸ” LET'S ENCRYPT â€” ACME CHALLENGE (HTTP)
        location ^~ /.well-known/acme-challenge/ {
            root /usr/share/nginx/html;
            default_type "text/plain";
        }

        # ğŸ§  Active le cache (assets Vite hashÃ©s)
        # Vite gÃ©nÃ¨re gÃ©nÃ©ralement /assets/... avec un hash => on peut cache trÃ¨s longtemps
        location ^~ /assets/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        # ğŸ§  DÃ©sactive le cache sur index.html (SPA shell)
        # Important : Ã©vite de servir un vieux index qui pointe vers de nouveaux fichiers JS/CSS
        location = /index.html {
            add_header Cache-Control "no-store, no-cache, must-revalidate";
            expires off;
        }

        # âœ… Sert index.html mÃªme si un chemin est inconnu (React SPA)
        location / {
            try_files $uri $uri/ /index.html;
        }

        # ğŸ“¡ Proxy vers l'API backend
        location /api/ {
            proxy_pass http://backend/;  # âœ… Pas de prÃ©fixe cÃ´tÃ© backend => /api/users devient /users

            # ğŸ” RecommandÃ© (Express + Ã©ventuels WebSockets)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # ---------------------------------------------
    # ğŸŒ 6. HTTPS - BACKEND API
    # ---------------------------------------------
    server {
        listen 443 ssl;
        http2 on;
        server_name api.atelier-photo-montpellier.fr;

        ssl_certificate /etc/letsencrypt/live/api.atelier-photo-montpellier.fr/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/api.atelier-photo-montpellier.fr/privkey.pem;

        # ğŸ”’ Durcissement TLS/HSTS
        ssl_protocols TLSv1.2 TLSv1.3;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # ğŸ” LET'S ENCRYPT â€” ACME CHALLENGE (HTTP)
        location ^~ /.well-known/acme-challenge/ {
            root /usr/share/nginx/html;
            default_type "text/plain";
        }

        # ğŸ“¡ Route vers le serveur backend
        location / {
            proxy_pass http://backend/;

            # ğŸ” RecommandÃ© (Express + Ã©ventuels WebSockets)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
